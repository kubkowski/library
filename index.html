<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Library</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
</head>
<body>

	<div class="container">

	<script id="author-list" type="text/template">
		<h1>Authors</h1>
		<a href="#/authors/new" class="btn btn-primary">New author</a>
		<hr />
		<table class="table striped">
			<thead>
				<tr>
					<th>First name</th>
					<th>Last name</th>
					<th></th>
				</tr>
			</thead>
			<tbody class="page">							

			</tbody>
		</table>

	</script>

	</div>

	<script id="authors-list-item" type="text/template">	
		<td><%= htmlEncode(first_name) %></td>
		<td><%= htmlEncode(last_name) %></td>
		<td><a href="#/authors/edit/<%= id %>" class="btn btn-primary">Edit Author</a></td>
	</script>
<!--
	<script id="publishers-list-item" type="text/template">
		<td><%= htmlEncode(name) %></td>
		<td><%= htmlEncode(establishedYear) %></td>
		<td></td>
	</script>
-->	

	<script id='edit-author' type='text/template'>
		<h1>Authors</h1>
		<hr />
		<form class="edit-author-form">
			<legend>Create author:</legend>
			<label>First name:</label>
			<input type="text" name="first_name" value="" />
			<label>Last name:</label>
			<input type="text" name="last_name" value="" />
			<hr />
			<button type="submit" class="btn">Create Author</button>
		</form>
	</script>


	
	
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>	
	<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js"></script>
	<script src="/app/models/author.js"></script>

	<script src="/app/collections/authors.js"></script>
	
	<script src="/app/helpers/applicationhelper.js"></script>
<!--
	<script src="/app/models/publisher.js"></script>
	<script src="/app/collections/publishers.js"></script>
	<script src="/app/views/publishers.js"></script>
	<script src="/app/views/authors.js"></script>
-->
	<script type="text/javascript">

		AuthorsItemView = Backbone.View.extend({
			tagName: 'tr',
			template: _.template($("#authors-list-item").html()),
			render: function() {
      	this.$el.html(this.template(this.model.toJSON()));
      	return this;
     	}
		});	

		AuthorList = Backbone.View.extend({
			el: '.page',
			render: function(){
				var self = this;
				var authors = new Authors();
				authors.fetch({
					success: function(authors){
							_.each(authors.models, function(author){
								self.$el.append(new AuthorsItemView({model: author}).render().el)
							});
					}
				});				
			}
		});

		Header = Backbone.View.extend({
			el: '.container',
			template: _.template($("#author-list").html()),
			render:function(){
				this.$el.empty().html(this.template);
			}
		})

		EditAuthor = Backbone.View.extend({
			el: '.container',
			template: _.template($('#edit-author').html()),
			render: function(){
				this.$el.empty();
				this.$el.html(this.template);
			},
			events: {
				'submit .edit-author-form': 'saveAuthor'
			},
			saveAuthor: function(ev){
				var authorDetails = $(ev.currentTarget).serializeObject();
				var author = new Author();
				console.log(author);
				console.log(authorDetails);
				author.save(authorDetails, {
				success: function(){
						console.log(router);
						router.navigate('', {trigger:true});
					}
				});
				return false;
			}
		});

		Router = Backbone.Router.extend({
			routes: {
				'': 'authorsList',
				'authors': 'authorsList',
				'authors/new': 'editAuthor',
//				'authors/edit/:id': 'editAuthor',
//				'publishers' : 'publishersList'
			},
		
		});

		
		

		var router = new Router();

		router.on('route:authorsList', function(){			
			var header = new Header();
			header.render();
			var authorList = new AuthorList();
			authorList.render();
		});

		router.on('route:editAuthor', function(){
			var editAuthor = new EditAuthor();
			editAuthor.render();
		});



		Backbone.history.start();

	</script>
		
</body>
</html>